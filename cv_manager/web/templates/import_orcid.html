{% extends "base.html" %}

{% block title %}Import ORCID - CV Manager{% endblock %}
{% block page_title %}Import Publications from ORCID{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="card">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-xl font-semibold text-gray-800">Import from ORCID Profile</h3>
                <p class="text-gray-600 mt-1">Enter your ORCID ID to automatically import your publications.</p>
            </div>
            <div class="flex space-x-3">
                <a href="{{ url_for('publications') }}" class="btn-secondary">
                    <i class="fas fa-list mr-2"></i>
                    View Publications
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Dashboard
                </a>
            </div>
        </div>

        <!-- Import Form -->
        <form method="POST" class="space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <!-- ORCID ID Input -->
            <div class="form-group">
                <label for="orcid_id" class="form-label">
                    <i class="fab fa-orcid mr-2"></i>
                    ORCID ID *
                </label>
                <div class="mt-1">
                    <input
                        type="text"
                        id="orcid_id"
                        name="orcid_id"
                        class="form-input"
                        placeholder="0000-0000-0000-0000 or https://orcid.org/0000-0000-0000-0000"
                        pattern="(https:\/\/orcid\.org\/)?\d{4}-\d{4}-\d{4}-\d{3}[\dX]"
                        required
                    >
                </div>
                <p class="text-sm text-gray-500 mt-1">
                    Enter your ORCID identifier. You can copy it from your ORCID profile URL.
                </p>
                <div id="orcid-preview" class="hidden mt-2 p-2 bg-blue-50 rounded border">
                    <div class="flex items-center text-sm text-blue-700">
                        <i class="fab fa-orcid mr-2"></i>
                        <span>ORCID Profile: </span>
                        <a id="orcid-link" href="#" target="_blank" class="ml-1 font-medium hover:underline"></a>
                    </div>
                </div>
            </div>

            <!-- Import Options -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="text-lg font-medium text-gray-800 mb-3">Import Options</h4>
                <div class="space-y-3">
                    <div class="flex items-center">
                        <input
                            id="merge"
                            name="merge"
                            type="checkbox"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                            checked
                        >
                        <label for="merge" class="ml-2 text-sm text-gray-700">
                            <strong>Merge with existing publications</strong>
                            <div class="text-gray-500">Combine ORCID publications with your current publications.yaml file</div>
                        </label>
                    </div>

                    <div class="flex items-center">
                        <input
                            id="backup"
                            name="backup"
                            type="checkbox"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                            checked
                        >
                        <label for="backup" class="ml-2 text-sm text-gray-700">
                            <strong>Create backup</strong>
                            <div class="text-gray-500">Save a backup copy of your current publications.yaml file</div>
                        </label>
                    </div>

                    <div class="flex items-center">
                        <input
                            id="sandbox"
                            name="sandbox"
                            type="checkbox"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        >
                        <label for="sandbox" class="ml-2 text-sm text-gray-700">
                            <strong>Use sandbox environment</strong>
                            <div class="text-gray-500">Use ORCID sandbox for testing (only check if you're testing with sandbox data)</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- How it Works -->
            <div class="bg-green-50 p-4 rounded-lg">
                <h4 class="text-lg font-medium text-green-800 mb-2">
                    <i class="fab fa-orcid mr-2"></i>
                    How ORCID Import Works
                </h4>
                <div class="text-sm text-green-700 space-y-2">
                    <p><strong>Automatic Categorization:</strong> Publications are automatically sorted by type:</p>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li><code>journal-article</code> → Journal Papers</li>
                        <li><code>conference-paper</code> → Conference Papers (grouped by year)</li>
                        <li><code>preprint</code> → Preprints</li>
                        <li><code>working-paper</code> → Under Review</li>
                    </ul>
                    <p><strong>Rich Metadata:</strong> Extracts authors, titles, journals, years, DOIs, and publication dates.</p>
                    <p><strong>Duplicate Protection:</strong> Prevents duplicate imports by comparing titles and DOIs.</p>
                    <p><strong>Privacy Respect:</strong> Only imports publicly visible works from your ORCID profile.</p>
                </div>
            </div>

            <!-- Privacy Notice -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h4 class="text-lg font-medium text-blue-800 mb-2">
                    <i class="fas fa-shield-alt mr-2"></i>
                    Privacy & Access
                </h4>
                <div class="text-sm text-blue-700 space-y-2">
                    <p><strong>Public Data Only:</strong> This tool only accesses publicly visible information from your ORCID profile.</p>
                    <p><strong>No Authentication Required:</strong> We don't store your ORCID credentials or require you to log in.</p>
                    <p><strong>Visibility Settings:</strong> If no publications are found, check that your works are set to "Public" in your ORCID profile.</p>
                    <p><strong>Direct API Access:</strong> We fetch data directly from ORCID's public API - no intermediary services.</p>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                <div class="text-sm text-gray-500">
                    <i class="fab fa-orcid mr-1"></i>
                    Enter your ORCID ID to get started
                </div>
                <div class="space-x-3">
                    <a href="{{ url_for('publications') }}" class="btn-secondary">
                        Cancel
                    </a>
                    <button type="submit" class="btn-primary" id="import-btn">
                        <i class="fas fa-download mr-2"></i>
                        Import from ORCID
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Find Your ORCID ID -->
    <div class="mt-8 card">
        <h4 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-question-circle mr-2"></i>
            How to Find Your ORCID ID
        </h4>
        <div class="space-y-4">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                <div>
                    <p class="font-medium text-gray-800">Visit your ORCID profile</p>
                    <p class="text-gray-600">Go to <a href="https://orcid.org" target="_blank" class="text-blue-600 hover:underline">orcid.org</a> and sign in to your account</p>
                </div>
            </div>
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                <div>
                    <p class="font-medium text-gray-800">Copy your ORCID ID</p>
                    <p class="text-gray-600">Your ORCID ID appears in the URL (https://orcid.org/0000-0000-0000-0000) and at the top of your profile page</p>
                </div>
            </div>
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                <div>
                    <p class="font-medium text-gray-800">Check visibility settings</p>
                    <p class="text-gray-600">Make sure your works are set to "Public" visibility if you want them to be imported</p>
                </div>
            </div>
        </div>

        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start space-x-2">
                <i class="fas fa-lightbulb text-yellow-600 mt-1"></i>
                <div class="text-sm text-yellow-800">
                    <strong>Don't have an ORCID ID yet?</strong>
                    <p>ORCID is a free service that provides researchers with a unique identifier. <a href="https://orcid.org/register" target="_blank" class="text-yellow-700 underline hover:text-yellow-900">Create your ORCID profile here</a>.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Example ORCID Formats -->
    <div class="mt-8 card">
        <h4 class="text-lg font-semibold text-gray-800 mb-4">Accepted ORCID ID Formats</h4>
        <div class="bg-gray-900 text-gray-100 p-4 rounded-lg space-y-2">
            <div class="text-sm space-y-1">
                <div><span class="text-green-400">✓</span> <code>0000-0000-0000-0000</code> (Standard format)</div>
                <div><span class="text-green-400">✓</span> <code>https://orcid.org/0000-0000-0000-0000</code> (Full URL)</div>
                <div><span class="text-green-400">✓</span> <code>0000000000000000</code> (Without dashes)</div>
                <div><span class="text-green-400">✓</span> <code>0000-0000-0000-000X</code> (With check digit X)</div>
            </div>
        </div>
        <p class="text-sm text-gray-600 mt-3">
            The system automatically validates and normalizes your ORCID ID format.
        </p>
    </div>
</div>

{% block extra_js %}
<script>
    // ORCID ID validation and preview
    const orcidInput = document.getElementById('orcid_id');
    const orcidPreview = document.getElementById('orcid-preview');
    const orcidLink = document.getElementById('orcid-link');

    orcidInput.addEventListener('input', function(e) {
        const value = e.target.value.trim();

        if (value) {
            // Extract ORCID ID from various formats
            let orcidId = value.replace(/^https?:\/\/orcid\.org\//, '');
            orcidId = orcidId.replace(/[^\d\-X]/g, '');

            // Add dashes if missing
            if (orcidId.length === 16 && orcidId.indexOf('-') === -1) {
                orcidId = orcidId.substring(0,4) + '-' +
                         orcidId.substring(4,8) + '-' +
                         orcidId.substring(8,12) + '-' +
                         orcidId.substring(12,16);
            }

            // Validate format
            const orcidPattern = /^\d{4}-\d{4}-\d{4}-\d{3}[\dX]$/;
            if (orcidPattern.test(orcidId)) {
                orcidLink.textContent = `https://orcid.org/${orcidId}`;
                orcidLink.href = `https://orcid.org/${orcidId}`;
                orcidPreview.classList.remove('hidden');
            } else {
                orcidPreview.classList.add('hidden');
            }
        } else {
            orcidPreview.classList.add('hidden');
        }
    });

    // Auto-format ORCID ID
    orcidInput.addEventListener('blur', function(e) {
        const value = e.target.value.trim();
        if (value) {
            // Clean and format ORCID ID
            let orcidId = value.replace(/^https?:\/\/orcid\.org\//, '');
            orcidId = orcidId.replace(/[^\d\-X]/g, '').toUpperCase();

            // Add dashes if missing
            if (orcidId.length === 16 && orcidId.indexOf('-') === -1) {
                orcidId = orcidId.substring(0,4) + '-' +
                         orcidId.substring(4,8) + '-' +
                         orcidId.substring(8,12) + '-' +
                         orcidId.substring(12,16);
            }

            e.target.value = orcidId;
        }
    });

    // Form submission loading state
    const form = document.querySelector('form');
    const importBtn = document.getElementById('import-btn');

    form.addEventListener('submit', function() {
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Importing...';
    });
</script>
{% endblock %}
{% endblock %}